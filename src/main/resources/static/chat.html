<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网球聊天室</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 10px;
        }
        label {
            display: inline-block;
            width: 100px;
        }
        input, button {
            padding: 5px;
        }
        #chat-messages {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            position: relative;
        }
        .message:hover {
            background-color: #e6f7ff;
        }
        .system-message {
            background-color: #e0e0e0;
            font-style: italic;
            color: #666;
        }
        .user-message {
            background-color: #d1e7ff;
        }
        .own-message {
            background-color: #c2f0c2;
        }
        .message-header {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 4px;
        }
        .message-content {
            word-wrap: break-word;
        }
        .username {
            font-weight: bold;
        }
        .timestamp {
            float: right;
            font-size: 0.8em;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .connected {
            background-color: green;
        }
        .disconnected {
            background-color: red;
        }
        .connecting {
            background-color: orange;
        }
        .reconnecting {
            background-color: yellow;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-height: 70%;
            overflow-y: auto;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
        }
        .analysis-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .analysis-section {
            margin-bottom: 15px;
        }
        .analysis-section h3 {
            margin: 10px 0 5px 0;
            color: #555;
        }
        .analysis-content {
            white-space: pre-wrap;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
        }
        /* 添加调试信息样式 */
        .debug-info {
            background-color: #ffffcc;
            border: 1px solid #ffcc00;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-size: 0.9em;
        }
        /* 分析状态指示器 */
        .analysis-status {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.7em;
            padding: 2px 5px;
            border-radius: 3px;
            background-color: #ffeb3b;
            color: #333;
        }
        .analysis-complete {
            background-color: #4caf50;
            color: white;
        }
        .analysis-error {
            background-color: #f44336;
            color: white;
        }
        /* 自动显示分析结果的面板 */
        .auto-analysis-panel {
            margin-top: 10px;
            padding: 10px;
            background-color: #e8f4f8;
            border-left: 3px solid #2196f3;
            border-radius: 3px;
            display: none;
        }
        .auto-analysis-panel.visible {
            display: block;
        }
        .auto-analysis-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: #1976d2;
        }
        .auto-analysis-content {
            font-size: 0.9em;
        }
    </style>
</head>
<body>
<h1>网球聊天室</h1>

<div class="container">
    <h2>创建或加入房间</h2>
    <div class="input-group">
        <button id="create-room">创建房间</button>
    </div>
    <div class="input-group">
        <label for="room-id">房间ID:</label>
        <input type="text" id="room-id" placeholder="输入房间ID">
        <button id="join-room">加入房间</button>
    </div>
    <div id="current-room" style="display:none;">
        <p>当前房间ID: <span id="current-room-id"></span></p>
        <p>连接状态: <span id="connection-status" class="status-indicator disconnected"></span><span id="status-text">未连接</span></p>
        <button id="leave-room">关闭房间</button>
    </div>
</div>

<div class="container" id="chat-container" style="display:none;">
    <h2>聊天室</h2>
    <div id="chat-messages">
        <div class="loading">正在加载聊天历史...</div>
    </div>
    <div class="input-group">
        <input type="text" id="message-input" placeholder="输入消息..." maxlength="500">
        <button id="send-message">发送</button>
    </div>
</div>

<!-- 分析结果模态框 -->
<div id="analysisModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div class="analysis-title">沟通分析结果</div>
        <div id="debugInfo" class="debug-info" style="display: none;"></div>
        <div id="analysisContent"></div>
    </div>
</div>

<script src="js/jquery.min.js"></script>
<script>
    let currentRoomId = null;
    let currentUser = null;
    let websocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let reconnectTimeout = null;
    let isHistoryLoaded = false;
    let debugMode = false; // 调试模式开关

    // 消息分析缓存
    const analysisCache = new Map();
    // 正在分析的消息队列
    const analysisQueue = new Set();
    // 是否自动显示分析结果
    let autoShowAnalysis = true;

    // 获取模态框元素
    const modal = document.getElementById("analysisModal");
    const span = document.getElementsByClassName("close")[0];
    const debugInfo = document.getElementById("debugInfo");

    // 点击关闭按钮关闭模态框
    span.onclick = function() {
        modal.style.display = "none";
    }

    // 点击模态框外部关闭它
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // 创建房间
    $('#create-room').click(function() {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('请先登录');
            window.location.href = 'login.html';
            return;
        }

        $.ajax({
            url: '/api/chat/create',
            type: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(data) {
                if (data.success) {
                    // 直接从token中解析用户名
                    const username = parseJwt(token).sub;
                    currentUser = username;
                    joinRoom(data.roomId, username);
                } else {
                    alert('创建房间失败: ' + data.message);
                }
            },
            error: function(xhr, status, error) {
                if (xhr.status === 401) {
                    alert('认证失败，请重新登录');
                    window.location.href = 'login.html';
                } else {
                    alert('创建房间时发生错误');
                }
            }
        });
    });

    // 加入房间
    $('#join-room').click(function() {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('请先登录');
            window.location.href = 'login.html';
            return;
        }

        const roomId = $('#room-id').val();
        if (roomId) {
            // 直接从token中解析用户名
            const username = parseJwt(token).sub;
            currentUser = username;
            joinRoom(roomId, username);
        } else {
            alert('请输入房间ID');
        }
    });

    // 离开房间
    $('#leave-room').click(function() {
        leaveRoom();
    });

    // 发送消息
    $('#send-message').click(function() {
        sendMessage();
    });

    // 回车发送消息
    $('#message-input').keypress(function(e) {
        if (e.which === 13) {
            sendMessage();
        }
    });

    function joinRoom(roomId, username) {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('请先登录');
            window.location.href = 'login.html';
            return;
        }

        $.ajax({
            url: '/api/chat/join',
            type: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            contentType: 'application/json',
            data: JSON.stringify({ roomId: roomId }),
            success: function(data) {
                if (data.success) {
                    currentRoomId = roomId;
                    $('#current-room-id').text(roomId);
                    $('#current-room').show();
                    $('#chat-container').show();

                    // 重置历史记录加载状态
                    isHistoryLoaded = false;
                    $('#chat-messages').html('<div class="loading">正在加载聊天历史...</div>');

                    // 获取聊天历史记录
                    loadChatHistory(roomId, token, function() {
                        // 连接WebSocket
                        connectWebSocket(roomId, username);
                    });
                } else {
                    alert('加入房间失败: ' + data.message);
                }
            },
            error: function(xhr, status, error) {
                if (xhr.status === 401) {
                    alert('认证失败，请重新登录');
                    window.location.href = 'login.html';
                } else {
                    alert('加入房间时发生错误');
                }
            }
        });
    }

    function loadChatHistory(roomId, token, callback) {
        $.ajax({
            url: '/api/chat/history/' + roomId,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            success: function(data) {
                if (data.success) {
                    // 清空加载提示
                    $('#chat-messages').empty();

                    // 显示历史消息
                    if (data.history && data.history.length > 0) {
                        data.history.forEach(function(msg) {
                            const isOwnMessage = (msg.username === currentUser);
                            addMessage(msg.username, msg.chat,
                                new Date(msg.create_time).toLocaleString(),
                                isOwnMessage ? 'own' : 'user', msg.id);
                        });
                    } else {
                        addMessage('系统', '还没有聊天记录', new Date().toLocaleString(), 'system');
                    }

                    isHistoryLoaded = true;
                    if (callback) callback();
                } else {
                    $('#chat-messages').html('<div class="loading">加载聊天历史失败: ' + data.message + '</div>');
                    if (callback) callback();
                }
            },
            error: function(xhr, status, error) {
                $('#chat-messages').html('<div class="loading">加载聊天历史失败</div>');
                if (callback) callback();
            }
        });
    }

    function connectWebSocket(roomId, username) {
        // 清除之前的重连尝试
        if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
            reconnectTimeout = null;
        }

        // 关闭已存在的连接
        if (websocket) {
            websocket.close();
        }

        // 更新状态为连接中
        updateConnectionStatus('connecting');

        // 创建新的WebSocket连接
        const wsUrl = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') +
            window.location.host + '/ws/chat';
        websocket = new WebSocket(wsUrl);

        websocket.onopen = function(event) {
            console.log('WebSocket连接已建立');
            reconnectAttempts = 0; // 重置重连次数
            updateConnectionStatus('connected');

            // 发送加入房间消息
            const joinMessage = {
                type: 'join',
                roomId: roomId,
                username: username
            };
            websocket.send(JSON.stringify(joinMessage));
        };

        websocket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            handleMessage(data);
        };

        websocket.onclose = function(event) {
            console.log('WebSocket连接已关闭', event);
            updateConnectionStatus('disconnected');

            // 如果不是主动关闭且还有重连次数，则尝试重连
            if (currentRoomId && reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                updateConnectionStatus('reconnecting');
                reconnectTimeout = setTimeout(function() {
                    if (currentRoomId && currentUser) {
                        connectWebSocket(currentRoomId, currentUser);
                    }
                }, 1000 * reconnectAttempts); // 递增延迟重连
            }
        };

        websocket.onerror = function(error) {
            console.error('WebSocket错误:', error);
            updateConnectionStatus('disconnected');
        };
    }

    function handleMessage(data) {
        switch (data.type) {
            case 'welcome':
                // 欢迎消息不显示在聊天记录中
                break;
            case 'userJoined':
                addMessage('系统', `${data.username} 加入了聊天室`,
                    new Date(data.timestamp).toLocaleString(), 'system');
                break;
            case 'userLeft':
                addMessage('系统', `${data.username} 离开了聊天室`,
                    new Date(data.timestamp).toLocaleString(), 'system');
                break;
            case 'message':
                const isOwnMessage = (data.username === currentUser);
                const messageId = data.messageId || ('msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9));
                addMessage(data.username, data.content,
                    new Date(data.timestamp).toLocaleString(),
                    isOwnMessage ? 'own' : 'user', messageId);

                // 自动分析所有消息（发送和接收的）
                autoAnalyzeMessage(data.content, messageId);
                break;
            case 'error':
                alert('错误: ' + data.error);
                break;
            default:
                console.log('未知消息类型:', data);
        }
    }

    function sendMessage() {
        const message = $('#message-input').val().trim();
        if (message && currentRoomId && websocket && websocket.readyState === WebSocket.OPEN) {
            const messageObj = {
                type: 'message',
                roomId: currentRoomId,
                username: currentUser,
                content: message
            };
            websocket.send(JSON.stringify(messageObj));
            $('#message-input').val('');
        } else if (!message) {
            alert('请输入消息内容');
        } else if (!websocket || websocket.readyState !== WebSocket.OPEN) {
            alert('连接已断开，请重新加入房间');
            // 尝试重新连接
            if (currentRoomId && currentUser) {
                connectWebSocket(currentRoomId, currentUser);
            }
        }
    }

    function leaveRoom() {
        // 清除重连定时器
        if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
            reconnectTimeout = null;
        }

        if (currentRoomId && websocket && websocket.readyState === WebSocket.OPEN) {
            // 发送离开房间消息
            const leaveMessage = {
                type: 'leave',
                roomId: currentRoomId,
                username: currentUser
            };
            websocket.send(JSON.stringify(leaveMessage));
        }

        // 关闭WebSocket连接
        if (websocket) {
            websocket.close();
            websocket = null;
        }

        // 重置重连次数
        reconnectAttempts = 0;

        // 如果是创建者，关闭房间
        const token = localStorage.getItem('token');
        if (token && currentUser) {
            $.ajax({
                url: '/api/chat/close',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                contentType: 'application/json',
                data: JSON.stringify({ roomId: currentRoomId }),
                success: function(data) {
                    if (!data.success) {
                        console.log('关闭房间失败: ' + data.message);
                    }
                },
                error: function(xhr, status, error) {
                    if (xhr.status !== 401) {
                        console.log('关闭房间时发生错误');
                    }
                }
            });
        }

        // 隐藏聊天界面
        $('#chat-container').hide();
        $('#current-room').hide();
        $('#chat-messages').empty();
        currentRoomId = null;
        currentUser = null;
        isHistoryLoaded = false;
    }

    function addMessage(username, content, timestamp, type, messageId = null) {
        const chatContainer = $('#chat-messages');
        const messageDiv = $('<div class="message"></div>');
        const uniqueId = messageId || 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        switch (type) {
            case 'system':
                messageDiv.addClass('system-message');
                break;
            case 'own':
                messageDiv.addClass('own-message');
                break;
            case 'user':
            default:
                messageDiv.addClass('user-message');
                break;
        }

        // 检查是否有缓存的分析结果
        let analysisStatus = '';
        if (analysisCache.has(uniqueId)) {
            analysisStatus = '<span class="analysis-status analysis-complete">已分析</span>';
        } else if (analysisQueue.has(uniqueId)) {
            analysisStatus = '<span class="analysis-status">分析中...</span>';
        }

        messageDiv.html(`
            <div class="message-header">
                <span class="username">${username}</span>
                <span class="timestamp">${timestamp}</span>
                ${analysisStatus}
            </div>
            <div class="message-content">${escapeHtml(content)}</div>
            <div class="auto-analysis-panel" id="analysis-panel-${uniqueId}"></div>
        `);

        // 给消息元素设置唯一ID以便后续更新
        messageDiv.attr('data-message-id', uniqueId);

        chatContainer.append(messageDiv);
        chatContainer.scrollTop(chatContainer[0].scrollHeight);

        return uniqueId;
    }

    // 自动分析所有消息（发送和接收的）
    function autoAnalyzeMessage(content, messageId) {
        const token = localStorage.getItem('token');
        if (!token || !messageId) return;

        // 检查缓存中是否已有分析结果
        if (analysisCache.has(messageId)) {
            updateMessageAnalysisStatus(messageId, 'complete');
            // 如果启用了自动显示，直接显示分析结果
            if (autoShowAnalysis) {
                displayAutoAnalysis(messageId, analysisCache.get(messageId));
            }
            return;
        }

        // 标记为正在分析
        analysisQueue.add(messageId);
        updateMessageAnalysisStatus(messageId, 'pending');

        // 调用分析接口
        $.ajax({
            url: '/api/analysis/communication',
            type: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({
                message: content,
                emotion: "未知"
            }),
            success: function(data) {
                analysisQueue.delete(messageId);
                if (data.success) {
                    // 缓存分析结果
                    analysisCache.set(messageId, data.analysis);
                    updateMessageAnalysisStatus(messageId, 'complete');

                    // 如果启用了自动显示，直接显示分析结果
                    if (autoShowAnalysis) {
                        displayAutoAnalysis(messageId, data.analysis);
                    }
                } else {
                    updateMessageAnalysisStatus(messageId, 'error');
                }
            },
            error: function(xhr, status, error) {
                analysisQueue.delete(messageId);
                updateMessageAnalysisStatus(messageId, 'error');
            }
        });
    }

    // 在消息下方自动显示分析结果
    function displayAutoAnalysis(messageId, analysisText) {
        try {
            // 提取越网判断结果
            let summary = "分析中...";
            if (analysisText.includes("【越网判断】：是")) {
                summary = "⚠️ 越网警告";
            } else if (analysisText.includes("【越网判断】：否")) {
                summary = "✅ 表达合规";
            }

            const panel = $(`#analysis-panel-${messageId}`);
            if (panel.length) {
                panel.html(`
                    <div class="auto-analysis-header">${summary}</div>
                    <div class="auto-analysis-content">点击查看详情</div>
                `);
                panel.addClass('visible');

                // 添加点击事件显示详细分析
                panel.off('click').on('click', function() {
                    showAnalysisDetail(analysisText);
                });
            }
        } catch (e) {
            console.error("显示自动分析结果时出错:", e);
        }
    }

    // 更新消息的分析状态显示
    function updateMessageAnalysisStatus(messageId, status) {
        const messageElement = $(`[data-message-id="${messageId}"]`);
        if (!messageElement.length) return;

        let statusHtml = '';
        switch (status) {
            case 'pending':
                statusHtml = '<span class="analysis-status">分析中...</span>';
                break;
            case 'complete':
                statusHtml = '<span class="analysis-status analysis-complete">已分析</span>';
                break;
            case 'error':
                statusHtml = '<span class="analysis-status analysis-error">分析失败</span>';
                break;
        }

        const header = messageElement.find('.message-header');
        // 移除旧的状态指示器
        header.find('.analysis-status').remove();
        // 添加新的状态指示器
        header.append(statusHtml);
    }

    // 显示详细分析结果（在模态框中）
    function showAnalysisDetail(analysisText) {
        // 显示加载状态
        document.getElementById('analysisContent').innerHTML = '<div class="loading">正在格式化分析结果...</div>';
        modal.style.display = "block";

        setTimeout(() => {
            formatAnalysisResult(analysisText);
        }, 100);
    }

    function showAnalysis(messageContent, messageId) {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('请先登录');
            return;
        }

        // 显示加载状态
        document.getElementById('analysisContent').innerHTML = '<div class="loading">正在分析消息...</div>';
        debugInfo.style.display = debugMode ? 'block' : 'none';
        debugInfo.innerHTML = '请求分析: ' + messageContent;
        modal.style.display = "block";

        // 首先检查缓存
        if (messageId && analysisCache.has(messageId)) {
            formatAnalysisResult(analysisCache.get(messageId));
            if (debugMode) {
                debugInfo.innerHTML += '<br>使用缓存结果';
            }
            return;
        }

        // 调用分析接口
        $.ajax({
            url: '/api/analysis/communication',
            type: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({
                message: messageContent,
                emotion: "未知"
            }),
            success: function(data) {
                console.log('分析请求成功，响应:', data);
                if (debugMode) {
                    debugInfo.innerHTML += '<br>响应: ' + JSON.stringify(data, null, 2);
                }

                if (data.success) {
                    // 缓存分析结果
                    if (messageId) {
                        analysisCache.set(messageId, data.analysis);
                        updateMessageAnalysisStatus(messageId, 'complete');
                    }
                    formatAnalysisResult(data.analysis);
                } else {
                    if (messageId) {
                        updateMessageAnalysisStatus(messageId, 'error');
                    }
                    document.getElementById('analysisContent').innerHTML =
                        '<div style="color: red;">分析失败: ' + data.message + '</div>';
                }
            },
            error: function(xhr, status, error) {
                console.error('分析请求失败:', xhr, status, error);
                if (debugMode) {
                    debugInfo.innerHTML += '<br>错误: ' + JSON.stringify(xhr, null, 2);
                }
                if (messageId) {
                    updateMessageAnalysisStatus(messageId, 'error');
                }
                document.getElementById('analysisContent').innerHTML =
                    '<div style="color: red;">分析请求失败: ' + error + '</div>';
            }
        });
    }

    function formatAnalysisResult(analysisText) {
        try {
            console.log("原始分析文本:", analysisText);

            // 如果分析文本包含错误信息，直接显示
            if (analysisText.startsWith("沟通分析失败") || analysisText.startsWith("分析完成，但无法解析结果")) {
                document.getElementById('analysisContent').innerHTML =
                    '<div style="color: red; white-space: pre-wrap;">' + escapeHtml(analysisText) + '</div>';
                return;
            }

            // 简单解析分析结果并格式化显示
            const sections = analysisText.split('\n\n');
            let formattedContent = '';

            sections.forEach((section, index) => {
                // 跳过空段落
                if (!section.trim()) return;

                if (section.startsWith('【') && section.includes('】')) {
                    const titleEndIndex = section.indexOf('】') + 1;
                    const title = section.substring(0, titleEndIndex);
                    const content = section.substring(titleEndIndex).trim();

                    formattedContent += `
                        <div class="analysis-section">
                            <h3>${escapeHtml(title)}</h3>
                            <div class="analysis-content">${escapeHtml(content).replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                } else {
                    // 处理没有标题的段落
                    formattedContent += `
                        <div class="analysis-section">
                            <div class="analysis-content">${escapeHtml(section).replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                }
            });

            // 如果没有格式化内容，显示原始文本
            if (!formattedContent.trim()) {
                formattedContent = '<div class="analysis-content">' + escapeHtml(analysisText).replace(/\n/g, '<br>') + '</div>';
            }

            document.getElementById('analysisContent').innerHTML = formattedContent;
        } catch (e) {
            console.error("格式化分析结果时出错:", e);
            document.getElementById('analysisContent').innerHTML =
                '<div style="color: red;">格式化结果时出错: ' + e.message + '</div><br>' +
                '<div class="analysis-content">' + escapeHtml(analysisText).replace(/\n/g, '<br>') + '</div>';
        }
    }

    function updateConnectionStatus(status) {
        const statusIndicator = $('#connection-status');
        const statusText = $('#status-text');

        statusIndicator.removeClass('connected disconnected connecting reconnecting');

        switch (status) {
            case 'connected':
                statusIndicator.addClass('connected');
                statusText.text('已连接');
                break;
            case 'disconnected':
                statusIndicator.addClass('disconnected');
                statusText.text('未连接');
                break;
            case 'connecting':
                statusIndicator.addClass('connecting');
                statusText.text('连接中...');
                break;
            case 'reconnecting':
                statusIndicator.addClass('reconnecting');
                statusText.text('重连中... (' + reconnectAttempts + '/' + maxReconnectAttempts + ')');
                break;
            default:
                statusIndicator.addClass('disconnected');
                statusText.text('未连接');
        }
    }

    function escapeHtml(text) {
        if (typeof text !== 'string') return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    // 解析JWT token获取用户信息
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error('解析JWT失败:', e);
            return {};
        }
    }

    // 页面加载时检查是否有token
    $(document).ready(function() {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('请先登录');
            window.location.href = 'login.html';
        }

        // 添加调试模式切换（按F12打开控制台，然后按D键切换）
        $(document).keydown(function(e) {
            if (e.key === 'd' || e.key === 'D') {
                debugMode = !debugMode;
                console.log('调试模式:', debugMode ? '开启' : '关闭');
            }
            // 按A键切换自动显示分析结果
            if (e.key === 'a' || e.key === 'A') {
                autoShowAnalysis = !autoShowAnalysis;
                console.log('自动显示分析结果:', autoShowAnalysis ? '开启' : '关闭');
            }
        });

        // 页面刷新时保存缓存到localStorage
        window.addEventListener('beforeunload', function() {
            try {
                const cacheData = {};
                for (let [key, value] of analysisCache) {
                    cacheData[key] = value;
                }
                localStorage.setItem('messageAnalysisCache', JSON.stringify(cacheData));
            } catch (e) {
                console.error('保存缓存失败:', e);
            }
        });

        // 页面加载时恢复缓存
        try {
            const savedCache = localStorage.getItem('messageAnalysisCache');
            if (savedCache) {
                const cacheData = JSON.parse(savedCache);
                for (let key in cacheData) {
                    analysisCache.set(key, cacheData[key]);
                }
                console.log('恢复了', Object.keys(cacheData).length, '条缓存记录');
            }
        } catch (e) {
            console.error('恢复缓存失败:', e);
        }
    });

    // 页面关闭前离开房间
    window.addEventListener('beforeunload', function() {
        if (currentRoomId) {
            leaveRoom();
        }
    });
</script>
</body>
</html>
