<!DOCTYPE html>
<html lang="zh-CN" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网球聊天室</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        tennis: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .message-container {
            scroll-behavior: smooth;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .score-positive {
            color: #10B981;
        }
        .score-negative {
            color: #EF4444;
        }
    </style>
</head>
<body class="h-full flex flex-col">
    <!-- Header -->
    <header class="bg-tennis-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold flex items-center">
                <i class="fas fa-table-tennis-paddle-ball mr-2"></i>
                网球聊天室
            </h1>
            <div id="user-info" class="text-sm hidden">
                <span id="current-user" class="font-medium"></span>
                <button id="logout-btn" class="ml-3 text-tennis-200 hover:text-white">
                    <i class="fas fa-sign-out-alt"></i> 退出
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-6 flex flex-col">
        <!-- Room Creation/Join Section -->
        <div id="room-section" class="max-w-2xl mx-auto w-full">
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">创建或加入房间</h2>

                <div class="space-y-4">
                    <button id="create-room" class="w-full bg-tennis-600 hover:bg-tennis-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                        <i class="fas fa-plus-circle mr-2"></i>
                        创建房间
                    </button>

                    <div class="flex space-x-2">
                        <input type="text" id="room-id" placeholder="输入房间ID"
                               class="flex-grow border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-tennis-500 focus:border-transparent">
                        <button id="join-room" class="bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">
                            加入
                        </button>
                    </div>
                </div>

                <div id="current-room" class="hidden mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-600">当前房间ID: <span id="current-room-id" class="font-medium text-gray-900"></span></p>
                            <div class="flex items-center mt-1">
                                <span id="connection-status" class="w-3 h-3 rounded-full bg-red-500 mr-2"></span>
                                <span id="status-text" class="text-sm text-gray-600">未连接</span>
                            </div>
                        </div>
                        <button id="leave-room" class="text-red-600 hover:text-red-800 font-medium">
                            <i class="fas fa-times mr-1"></i> 离开房间
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Container (Fullscreen when active) -->
        <div id="chat-container" class="hidden flex-grow flex flex-col">
            <!-- Scoreboard -->
            <div class="bg-white shadow-sm py-3 px-4 border-b border-gray-200">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex flex-wrap items-center gap-4">
                        <h2 class="text-lg font-bold text-gray-800">聊天室</h2>
                        <div class="flex items-center bg-gray-100 rounded-full px-4 py-1">
                            <span class="text-gray-600 mr-2">房间ID:</span>
                            <span id="chat-room-id" class="font-medium text-gray-800"></span>
                        </div>
                        <div class="flex items-center bg-gray-100 rounded-full px-4 py-1">
                            <span class="text-gray-600 mr-2">总分:</span>
                            <span id="score-display" class="font-bold text-lg score-positive">0</span>
                        </div>
                        <div class="flex items-center bg-gray-100 rounded-full px-4 py-1">
                            <span class="text-gray-600 mr-2">个人得分:</span>
                            <span id="personal-score-display" class="font-bold text-lg score-positive">0</span>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span id="connection-status-full" class="w-3 h-3 rounded-full bg-red-500 mr-2"></span>
                        <span id="status-text-full" class="text-sm text-gray-600 mr-4">未连接</span>
                        <button id="leave-room-full" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="chat-messages" class="flex-grow overflow-y-auto p-4 bg-gray-50 message-container">
                <div class="text-center text-gray-500 py-10">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>正在加载聊天历史...</p>
                </div>
            </div>

            <!-- Message Input -->
            <div class="bg-white border-t border-gray-200 p-4">
                <div class="flex">
                    <input type="text" id="message-input" placeholder="输入消息..." maxlength="500"
                           class="flex-grow border border-gray-300 rounded-l-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-tennis-500 focus:border-transparent">
                    <button id="send-message" class="bg-tennis-600 hover:bg-tennis-700 text-white font-medium px-6 py-2 rounded-r-lg transition duration-200">
                        发送
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Analysis Modal -->
    <div id="analysisModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">沟通分析结果</h3>
                <button class="close text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div id="debugInfo" class="bg-yellow-50 border-b border-yellow-200 p-4 text-sm text-yellow-800 hidden"></div>

            <div id="analysisContent" class="flex-grow overflow-y-auto p-6">
                <div class="text-center text-gray-500 py-10">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>正在分析消息...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script>
        // 保持原有的JavaScript逻辑不变，只修改UI相关部分
        let currentRoomId = null;
        let currentUser = null;
        let websocket = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let reconnectTimeout = null;
        let isHistoryLoaded = false;
        let debugMode = false;
        let score = 0; // 总分数
        let personalScore = 0; // 个人分数

        // 消息分析缓存
        const analysisCache = new Map();
        // 正在分析的消息队列
        const analysisQueue = new Set();
        // 是否自动显示分析结果
        let autoShowAnalysis = true;

        // 获取模态框元素
        const modal = document.getElementById("analysisModal");
        const span = document.getElementsByClassName("close")[0];
        const debugInfo = document.getElementById("debugInfo");

        // 点击关闭按钮关闭模态框
        span.onclick = function() {
            modal.style.display = "none";
        }

        // 点击模态框外部关闭它
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // 创建房间
        $('#create-room').click(function() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('请先登录');
                window.location.href = 'login.html';
                return;
            }

            $.ajax({
                url: '/api/chat/create',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function(data) {
                    if (data.success) {
                        // 直接从token中解析用户名
                        const username = parseJwt(token).sub;
                        currentUser = username;
                        joinRoom(data.roomId, username);
                    } else {
                        alert('创建房间失败: ' + data.message);
                    }
                },
                error: function(xhr, status, error) {
                    if (xhr.status === 401) {
                        alert('认证失败，请重新登录');
                        window.location.href = 'login.html';
                    } else {
                        alert('创建房间时发生错误');
                    }
                }
            });
        });

        // 加入房间
        $('#join-room').click(function() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('请先登录');
                window.location.href = 'login.html';
                return;
            }

            const roomId = $('#room-id').val();
            if (roomId) {
                // 直接从token中解析用户名
                const username = parseJwt(token).sub;
                currentUser = username;
                joinRoom(roomId, username);
            } else {
                alert('请输入房间ID');
            }
        });

        // 离开房间
        $('#leave-room, #leave-room-full').click(function() {
            leaveRoom();
        });

        // 发送消息
        $('#send-message').click(function() {
            sendMessage();
        });

        // 回车发送消息
        $('#message-input').keypress(function(e) {
            if (e.which === 13) {
                sendMessage();
            }
        });

        function joinRoom(roomId, username) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('请先登录');
                window.location.href = 'login.html';
                return;
            }

            $.ajax({
                url: '/api/chat/join',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                contentType: 'application/json',
                data: JSON.stringify({ roomId: roomId }),
                success: function(data) {
                    if (data.success) {
                        currentRoomId = roomId;
                        $('#current-room-id').text(roomId);
                        $('#chat-room-id').text(roomId);
                        $('#current-user').text(username);
                        $('#user-info').removeClass('hidden');

                        // 重置分数
                        score = 0;
                        personalScore = 0;
                        updateScoreDisplay();
                        updatePersonalScoreDisplay();

                        // 隐藏房间选择界面，显示全屏聊天界面
                        $('#room-section').addClass('hidden');
                        $('#chat-container').removeClass('hidden');

                        // 重置历史记录加载状态
                        isHistoryLoaded = false;
                        $('#chat-messages').html('<div class="text-center text-gray-500 py-10"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>正在加载聊天历史...</p></div>');

                        // 获取聊天历史记录
                        loadChatHistory(roomId, token, function() {
                            // 连接WebSocket
                            connectWebSocket(roomId, username);
                        });
                    } else {
                        alert('加入房间失败: ' + data.message);
                    }
                },
                error: function(xhr, status, error) {
                    if (xhr.status === 401) {
                        alert('认证失败，请重新登录');
                        window.location.href = 'login.html';
                    } else {
                        alert('加入房间时发生错误');
                    }
                }
            });
        }

        function loadChatHistory(roomId, token, callback) {
            $.ajax({
                url: '/api/chat/history/' + roomId,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                success: function(data) {
                    if (data.success) {
                        // 清空加载提示
                        $('#chat-messages').empty();

                        // 显示历史消息
                        if (data.history && data.history.length > 0) {
                            data.history.forEach(function(msg) {
                                const isOwnMessage = (msg.username === currentUser);
                                addMessage(msg.username, msg.chat,
                                    new Date(msg.create_time).toLocaleString(),
                                    isOwnMessage ? 'own' : 'user', msg.id);
                            });
                        } else {
                            addMessage('系统', '还没有聊天记录', new Date().toLocaleString(), 'system');
                        }

                        isHistoryLoaded = true;
                        if (callback) callback();
                    } else {
                        $('#chat-messages').html('<div class="text-center text-red-500 py-10"><p>加载聊天历史失败: ' + data.message + '</p></div>');
                        if (callback) callback();
                    }
                },
                error: function(xhr, status, error) {
                    $('#chat-messages').html('<div class="text-center text-red-500 py-10"><p>加载聊天历史失败</p></div>');
                    if (callback) callback();
                }
            });
        }

        function connectWebSocket(roomId, username) {
            // 清除之前的重连尝试
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }

            // 关闭已存在的连接
            if (websocket) {
                websocket.close();
            }

            // 更新状态为连接中
            updateConnectionStatus('connecting');

            // 创建新的WebSocket连接
            const wsUrl = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') +
                window.location.host + '/ws/chat';
            websocket = new WebSocket(wsUrl);

            websocket.onopen = function(event) {
                console.log('WebSocket连接已建立');
                reconnectAttempts = 0; // 重置重连次数
                updateConnectionStatus('connected');

                // 发送加入房间消息
                const joinMessage = {
                    type: 'join',
                    roomId: roomId,
                    username: username
                };
                websocket.send(JSON.stringify(joinMessage));
            };

            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };

            websocket.onclose = function(event) {
                console.log('WebSocket连接已关闭', event);
                updateConnectionStatus('disconnected');

                // 如果不是主动关闭且还有重连次数，则尝试重连
                if (currentRoomId && reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    updateConnectionStatus('reconnecting');
                    reconnectTimeout = setTimeout(function() {
                        if (currentRoomId && currentUser) {
                            connectWebSocket(currentRoomId, currentUser);
                        }
                    }, 1000 * reconnectAttempts); // 递增延迟重连
                }
            };

            websocket.onerror = function(error) {
                console.error('WebSocket错误:', error);
                updateConnectionStatus('disconnected');
            };
        }

        function handleMessage(data) {
            switch (data.type) {
                case 'welcome':
                    // 欢迎消息不显示在聊天记录中
                    break;
                case 'userJoined':
                    addMessage('系统', `${data.username} 加入了聊天室`,
                        new Date(data.timestamp).toLocaleString(), 'system');
                    break;
                case 'userLeft':
                    addMessage('系统', `${data.username} 离开了聊天室`,
                        new Date(data.timestamp).toLocaleString(), 'system');
                    break;
                case 'message':
                    const isOwnMessage = (data.username === currentUser);
                    const messageId = data.messageId || ('msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9));
                    addMessage(data.username, data.content,
                        new Date(data.timestamp).toLocaleString(),
                        isOwnMessage ? 'own' : 'user', messageId);

                    // 自动分析所有消息（发送和接收的）
                    autoAnalyzeMessage(data.content, messageId, isOwnMessage);
                    break;
                case 'error':
                    alert('错误: ' + data.error);
                    break;
                default:
                    console.log('未知消息类型:', data);
            }
        }

        function sendMessage() {
            const message = $('#message-input').val().trim();
            if (message && currentRoomId && websocket && websocket.readyState === WebSocket.OPEN) {
                const messageObj = {
                    type: 'message',
                    roomId: currentRoomId,
                    username: currentUser,
                    content: message
                };
                websocket.send(JSON.stringify(messageObj));
                $('#message-input').val('');
            } else if (!message) {
                alert('请输入消息内容');
            } else if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                alert('连接已断开，请重新加入房间');
                // 尝试重新连接
                if (currentRoomId && currentUser) {
                    connectWebSocket(currentRoomId, currentUser);
                }
            }
        }

        function leaveRoom() {
            // 清除重连定时器
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }

            if (currentRoomId && websocket && websocket.readyState === WebSocket.OPEN) {
                // 发送离开房间消息
                const leaveMessage = {
                    type: 'leave',
                    roomId: currentRoomId,
                    username: currentUser
                };
                websocket.send(JSON.stringify(leaveMessage));
            }

            // 关闭WebSocket连接
            if (websocket) {
                websocket.close();
                websocket = null;
            }

            // 重置重连次数
            reconnectAttempts = 0;

            // 如果是创建者，关闭房间
            const token = localStorage.getItem('token');
            if (token && currentUser) {
                $.ajax({
                    url: '/api/chat/close',
                    type: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    contentType: 'application/json',
                    data: JSON.stringify({ roomId: currentRoomId }),
                    success: function(data) {
                        if (!data.success) {
                            console.log('关闭房间失败: ' + data.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        if (xhr.status !== 401) {
                            console.log('关闭房间时发生错误');
                        }
                    }
                });
            }

            // 隐藏聊天界面，显示房间选择界面
            $('#chat-container').addClass('hidden');
            $('#room-section').removeClass('hidden');
            $('#chat-messages').empty();
            currentRoomId = null;
            currentUser = null;
            isHistoryLoaded = false;
        }

        function addMessage(username, content, timestamp, type, messageId = null) {
            const chatContainer = $('#chat-messages');
            const messageDiv = $('<div class="fade-in mb-3 rounded-lg p-3 max-w-[80%]"></div>');
            const uniqueId = messageId || 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            switch (type) {
                case 'system':
                    messageDiv.addClass('bg-gray-200 text-gray-700 mx-auto');
                    break;
                case 'own':
                    messageDiv.addClass('bg-tennis-100 text-gray-800 ml-auto');
                    break;
                case 'user':
                default:
                    messageDiv.addClass('bg-white text-gray-800 border border-gray-200');
                    break;
            }

            // 检查是否有缓存的分析结果
            let analysisStatus = '';
            if (analysisCache.has(uniqueId)) {
                analysisStatus = '<span class="ml-2 text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full">已分析</span>';
            } else if (analysisQueue.has(uniqueId)) {
                analysisStatus = '<span class="ml-2 text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">分析中...</span>';
            }

            messageDiv.html(`
                <div class="flex justify-between items-start mb-1">
                    <span class="font-bold text-sm">${username}</span>
                    <span class="text-xs text-gray-500">${timestamp}</span>
                </div>
                <div class="message-content">${escapeHtml(content)}</div>
                <div class="auto-analysis-panel mt-2 text-sm hidden" id="analysis-panel-${uniqueId}"></div>
            `);

            // 给消息元素设置唯一ID以便后续更新
            messageDiv.attr('data-message-id', uniqueId);

            chatContainer.append(messageDiv);
            chatContainer.scrollTop(chatContainer[0].scrollHeight);

            return uniqueId;
        }

        // 自动分析所有消息（发送和接收的）
        function autoAnalyzeMessage(content, messageId, isOwnMessage = false) {
            const token = localStorage.getItem('token');
            if (!token || !messageId) return;

            // 检查缓存中是否已有分析结果
            if (analysisCache.has(messageId)) {
                updateMessageAnalysisStatus(messageId, 'complete');
                // 如果启用了自动显示，直接显示分析结果
                if (autoShowAnalysis) {
                    displayAutoAnalysis(messageId, analysisCache.get(messageId));
                }
                return;
            }

            // 标记为正在分析
            analysisQueue.add(messageId);
            updateMessageAnalysisStatus(messageId, 'pending');

            // 调用分析接口
            $.ajax({
                url: '/api/analysis/communication',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    message: content,
                    emotion: "未知"
                }),
                success: function(data) {
                    analysisQueue.delete(messageId);
                    if (data.success) {
                        // 缓存分析结果
                        analysisCache.set(messageId, data.analysis);
                        updateMessageAnalysisStatus(messageId, 'complete');

                        // 更新分数
                        updateScore(data.analysis);

                        // 如果是自己的消息，更新个人分数
                        if (isOwnMessage) {
                            updatePersonalScore(data.analysis);
                        }

                        // 如果启用了自动显示，直接显示分析结果
                        if (autoShowAnalysis) {
                            displayAutoAnalysis(messageId, data.analysis);
                        }
                    } else {
                        updateMessageAnalysisStatus(messageId, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    analysisQueue.delete(messageId);
                    updateMessageAnalysisStatus(messageId, 'error');
                }
            });
        }

        // 根据分析结果更新总分数
        function updateScore(analysisText) {
            if (analysisText.includes("【越网判断】：是")) {
                score -= 1; // 越网扣1分
            } else if (analysisText.includes("【越网判断】：否")) {
                score += 1; // 未越网加1分
            }
            updateScoreDisplay();
        }

        // 根据分析结果更新个人分数
        function updatePersonalScore(analysisText) {
            if (analysisText.includes("【越网判断】：是")) {
                personalScore -= 1; // 越网扣1分
            } else if (analysisText.includes("【越网判断】：否")) {
                personalScore += 1; // 未越网加1分
            }
            updatePersonalScoreDisplay();
        }

        // 更新总分数显示
        function updateScoreDisplay() {
            const scoreDisplay = $('#score-display');
            scoreDisplay.text(score);

            // 根据分数正负改变颜色
            if (score > 0) {
                scoreDisplay.removeClass('score-negative').addClass('score-positive');
            } else if (score < 0) {
                scoreDisplay.removeClass('score-positive').addClass('score-negative');
            } else {
                scoreDisplay.removeClass('score-positive score-negative');
            }
        }

        // 更新个人分数显示
        function updatePersonalScoreDisplay() {
            const personalScoreDisplay = $('#personal-score-display');
            personalScoreDisplay.text(personalScore);

            // 根据分数正负改变颜色
            if (personalScore > 0) {
                personalScoreDisplay.removeClass('score-negative').addClass('score-positive');
            } else if (personalScore < 0) {
                personalScoreDisplay.removeClass('score-positive').addClass('score-negative');
            } else {
                personalScoreDisplay.removeClass('score-positive score-negative');
            }
        }

        function displayAutoAnalysis(messageId, analysisText) {
            try {
                let summary = "分析中...";
                if (analysisText.includes("【越网判断】：是")) {
                    summary = "⚠️ 越网警告";
                } else if (analysisText.includes("【越网判断】：否")) {
                    summary = "✅ 表达合规";
                }

                const panel = $(`#analysis-panel-${messageId}`);
                if (panel.length) {
                    panel.html(`
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-2">
                            <div class="font-bold text-blue-700">${summary}</div>
                            <div class="text-blue-600 mt-1">点击查看详情</div>
                        </div>
                    `);
                    panel.removeClass('hidden');

                    panel.off('click').on('click', function() {
                        showAnalysisDetail(analysisText);
                    });
                }
            } catch (e) {
                console.error("显示自动分析结果时出错:", e);
            }
        }

        function updateMessageAnalysisStatus(messageId, status) {
            const messageElement = $(`[data-message-id="${messageId}"]`);
            if (!messageElement.length) return;

            let statusHtml = '';
            switch (status) {
                case 'pending':
                    statusHtml = '<span class="ml-2 text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">分析中...</span>';
                    break;
                case 'complete':
                    statusHtml = '<span class="ml-2 text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full">已分析</span>';
                    break;
                case 'error':
                    statusHtml = '<span class="ml-2 text-xs px-2 py-1 bg-red-100 text-red-800 rounded-full">分析失败</span>';
                    break;
            }

            messageElement.find('.analysis-status').remove();
            messageElement.find('.message-header').append(statusHtml);
        }

        function showAnalysisDetail(analysisText) {
            document.getElementById('analysisContent').innerHTML = '<div class="text-center text-gray-500 py-10"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>正在格式化分析结果...</p></div>';
            modal.style.display = "flex";

            setTimeout(() => {
                formatAnalysisResult(analysisText);
            }, 100);
        }

        function showAnalysis(messageContent, messageId) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('请先登录');
                return;
            }

            document.getElementById('analysisContent').innerHTML = '<div class="text-center text-gray-500 py-10"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>正在分析消息...</p></div>';
            debugInfo.style.display = debugMode ? 'block' : 'none';
            debugInfo.innerHTML = '请求分析: ' + messageContent;
            modal.style.display = "flex";

            if (messageId && analysisCache.has(messageId)) {
                formatAnalysisResult(analysisCache.get(messageId));
                if (debugMode) {
                    debugInfo.innerHTML += '<br>使用缓存结果';
                }
                return;
            }

            $.ajax({
                url: '/api/analysis/communication',
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    message: messageContent,
                    emotion: "未知"
                }),
                success: function(data) {
                    console.log('分析请求成功，响应:', data);
                    if (debugMode) {
                        debugInfo.innerHTML += '<br>响应: ' + JSON.stringify(data, null, 2);
                    }

                    if (data.success) {
                        // 缓存分析结果
                        if (messageId) {
                            analysisCache.set(messageId, data.analysis);
                            updateMessageAnalysisStatus(messageId, 'complete');

                            updateScore(data.analysis);
                        }
                        formatAnalysisResult(data.analysis);
                    } else {
                        if (messageId) {
                            updateMessageAnalysisStatus(messageId, 'error');
                        }
                        document.getElementById('analysisContent').innerHTML =
                            '<div class="text-red-500 p-4"><p>分析失败: ' + data.message + '</p></div>';
                    }
                },
                error: function(xhr, status, error) {
                    console.error('分析请求失败:', xhr, status, error);
                    if (debugMode) {
                        debugInfo.innerHTML += '<br>错误: ' + JSON.stringify(xhr, null, 2);
                    }
                    if (messageId) {
                        updateMessageAnalysisStatus(messageId, 'error');
                    }
                    document.getElementById('analysisContent').innerHTML =
                        '<div class="text-red-500 p-4"><p>分析请求失败: ' + error + '</p></div>';
                }
            });
        }

        function formatAnalysisResult(analysisText) {
            try {
                console.log("原始分析文本:", analysisText);

                if (analysisText.startsWith("沟通分析失败") || analysisText.startsWith("分析完成，但无法解析结果")) {
                    document.getElementById('analysisContent').innerHTML =
                        '<div class="text-red-500 whitespace-pre-wrap p-4">' + escapeHtml(analysisText) + '</div>';
                    return;
                }

                const sections = analysisText.split('\n\n');
                let formattedContent = '';

                sections.forEach((section, index) => {

                    if (!section.trim()) return;

                    if (section.startsWith('【') && section.includes('】')) {
                        const titleEndIndex = section.indexOf('】') + 1;
                        const title = section.substring(0, titleEndIndex);
                        const content = section.substring(titleEndIndex).trim();

                        formattedContent += `
                            <div class="mb-6">
                                <h3 class="text-lg font-bold text-gray-800 mb-2">${escapeHtml(title)}</h3>
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">${escapeHtml(content).replace(/\n/g, '<br>')}</div>
                            </div>
                        `;
                    } else {
                        formattedContent += `
                            <div class="mb-6">
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">${escapeHtml(section).replace(/\n/g, '<br>')}</div>
                            </div>
                        `;
                    }
                });

                if (!formattedContent.trim()) {
                    formattedContent = '<div class="bg-gray-50 p-4 rounded-lg border border-gray-200">' + escapeHtml(analysisText).replace(/\n/g, '<br>') + '</div>';
                }

                document.getElementById('analysisContent').innerHTML = formattedContent;
            } catch (e) {
                console.error("格式化分析结果时出错:", e);
                document.getElementById('analysisContent').innerHTML =
                    '<div class="text-red-500 mb-4"><p>格式化结果时出错: ' + e.message + '</p></div>' +
                    '<div class="bg-gray-50 p-4 rounded-lg border border-gray-200">' + escapeHtml(analysisText).replace(/\n/g, '<br>') + '</div>';
            }
        }

        function updateConnectionStatus(status) {
            const statusIndicator = $('#connection-status, #connection-status-full');
            const statusText = $('#status-text, #status-text-full');

            statusIndicator.removeClass('bg-green-500 bg-red-500 bg-yellow-500 bg-orange-500');

            switch (status) {
                case 'connected':
                    statusIndicator.addClass('bg-green-500');
                    statusText.text('已连接');
                    break;
                case 'disconnected':
                    statusIndicator.addClass('bg-red-500');
                    statusText.text('未连接');
                    break;
                case 'connecting':
                    statusIndicator.addClass('bg-yellow-500');
                    statusText.text('连接中...');
                    break;
                case 'reconnecting':
                    statusIndicator.addClass('bg-orange-500');
                    statusText.text('重连中... (' + reconnectAttempts + '/' + maxReconnectAttempts + ')');
                    break;
                default:
                    statusIndicator.addClass('bg-red-500');
                    statusText.text('未连接');
            }
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error('解析JWT失败:', e);
                return {};
            }
        }

        $(document).ready(function() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('请先登录');
                window.location.href = 'login.html';
            } else {
                const username = parseJwt(token).sub;
                $('#current-user').text(username);
                $('#user-info').removeClass('hidden');
            }

            $(document).keydown(function(e) {
                if (e.key === 'd' || e.key === 'D') {
                    debugMode = !debugMode;
                    console.log('调试模式:', debugMode ? '开启' : '关闭');
                }

                if (e.key === 'a' || e.key === 'A') {
                    autoShowAnalysis = !autoShowAnalysis;
                    console.log('自动显示分析结果:', autoShowAnalysis ? '开启' : '关闭');
                }
            });

            window.addEventListener('beforeunload', function() {
                try {
                    const cacheData = {};
                    for (let [key, value] of analysisCache) {
                        cacheData[key] = value;
                    }
                    localStorage.setItem('messageAnalysisCache', JSON.stringify(cacheData));
                } catch (e) {
                    console.error('保存缓存失败:', e);
                }
            });

            try {
                const savedCache = localStorage.getItem('messageAnalysisCache');
                if (savedCache) {
                    const cacheData = JSON.parse(savedCache);
                    for (let key in cacheData) {
                        analysisCache.set(key, cacheData[key]);
                    }
                    console.log('恢复了', Object.keys(cacheData).length, '条缓存记录');
                }
            } catch (e) {
                console.error('恢复缓存失败:', e);
            }
        });

        window.addEventListener('beforeunload', function() {
            if (currentRoomId) {
                leaveRoom();
            }
        });

        $('#logout-btn').click(function() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        });
    </script>
</body>
</html>
